---
name: Run Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - dev
      - main

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # Detect what changed to decide which tests to run
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      api: ${{ steps.filter.outputs.api }}
      packages: ${{ steps.filter.outputs.packages }}
      e2e: ${{ steps.filter.outputs.e2e }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
            api:
              - 'apps/api/**'
            packages:
              - 'packages/**'
            e2e:
              - 'e2e-tests/**'
            workflows:
              - '.github/workflows/**'

  # Fast checks first - fail fast if basic issues
  quick-checks:
    name: Quick Checks (Type + Lint)
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for changed file detection

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

  # Unit tests - fast, isolated tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, quick-checks]
    # Skip if only workflow files changed
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.api == 'true' || needs.detect-changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need history for changed files detection

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests (changed packages only)
        if: github.event_name == 'pull_request'
        run: |
          # Use Turbo's cache and filter to run only affected tests
          pnpm turbo run test:unit --filter="...[origin/${{ github.base_ref }}]" --cache-dir=.turbo

      - name: Run all unit tests
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        run: pnpm test:unit

      - name: Upload unit test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: |
            packages/*/coverage/lcov.info
            apps/*/coverage/lcov.info
          retention-days: 7

  # Integration tests - slower, require setup
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, quick-checks]
    # Run in parallel with unit tests, skip if only workflows changed
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.api == 'true' || needs.detect-changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run integration tests (changed packages only)
        if: github.event_name == 'pull_request'
        run: |
          pnpm turbo run test:int --filter="...[origin/${{ github.base_ref }}]" --cache-dir=.turbo
        env:
          NODE_ENV: test

      - name: Run all integration tests
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        run: pnpm test:int
        env:
          NODE_ENV: test

      - name: Upload integration test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-coverage
          path: |
            packages/*/coverage/lcov.info
            apps/*/coverage/lcov.info
          retention-days: 7

  # Coverage report - combine all coverage
  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.integration-tests.result == 'success')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage
          path: coverage-temp/unit
        continue-on-error: true

      - name: Download integration test coverage
        uses: actions/download-artifact@v4
        with:
          name: integration-test-coverage
          path: coverage-temp/integration
        continue-on-error: true

      - name: Merge coverage reports
        run: pnpm coverage:merge
        continue-on-error: true

      - name: Install lcov (for genhtml)
        run: sudo apt-get update && sudo apt-get install -y lcov
      
      - name: Generate HTML report
        run: pnpm coverage:html
        continue-on-error: true

      - name: Upload merged coverage
        uses: actions/upload-artifact@v4
        with:
          name: merged-coverage
          path: coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let coverageMessage = 'üìä **Test Results Summary**\n\n';
            
            // Check test results
            const unitTestsPassed = '${{ needs.unit-tests.result }}' === 'success';
            const integrationTestsPassed = '${{ needs.integration-tests.result }}' === 'success';
            
            if (unitTestsPassed && integrationTestsPassed) {
              coverageMessage += '‚úÖ **All tests passed!**\n';
              coverageMessage += '‚Ä¢ Unit tests: ‚úÖ Passed\n';
              coverageMessage += '‚Ä¢ Integration tests: ‚úÖ Passed\n\n';
            } else if (unitTestsPassed) {
              coverageMessage += '‚úÖ **Unit tests passed!**\n';
              coverageMessage += '‚Ä¢ Unit tests: ‚úÖ Passed\n';
              coverageMessage += '‚Ä¢ Integration tests: ‚ùå Failed\n\n';
            } else if (integrationTestsPassed) {
              coverageMessage += '‚úÖ **Integration tests passed!**\n';
              coverageMessage += '‚Ä¢ Unit tests: ‚ùå Failed\n';
              coverageMessage += '‚Ä¢ Integration tests: ‚úÖ Passed\n\n';
            } else {
              coverageMessage += '‚ùå **All tests failed**\n\n';
              return; // Don't post comment if everything failed
            }
            
            // Check if coverage was generated
            const coverageDir = path.join(process.cwd(), 'coverage');
            if (fs.existsSync(coverageDir)) {
              coverageMessage += 'üìà **Coverage Report Generated**\n';
              coverageMessage += 'View the full coverage report in the workflow artifacts.\n\n';
            } else {
              coverageMessage += '‚ö†Ô∏è **Coverage Report**: No coverage data available\n\n';
            }
            
            if (github.event_name === 'pull_request') {
              coverageMessage += 'üí° **Note**: Only tests for changed files were run to speed up CI.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageMessage
            });  # Only run on main/dev branches or when specifically needed
  full-test-suite:
    name: Full Test Suite (All Tests)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || contains(github.event.head_commit.message, '[full-tests]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run all tests with coverage
        run: pnpm test:coverage

      - name: Upload full coverage
        uses: actions/upload-artifact@v4
        with:
          name: full-coverage-report
          path: coverage/
          retention-days: 90
