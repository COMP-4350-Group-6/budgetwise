---
name: Run Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - dev
      - main

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  # Detect what changed to decide which tests to run
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      api: ${{ steps.filter.outputs.api }}
      packages: ${{ steps.filter.outputs.packages }}
      e2e: ${{ steps.filter.outputs.e2e }}
      workflows: ${{ steps.filter.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
            api:
              - 'apps/api/**'
            packages:
              - 'packages/**'
            e2e:
              - 'e2e-tests/**'
            workflows:
              - '.github/workflows/**'

  # Fast checks first - fail fast if basic issues
  quick-checks:
    name: Quick Checks (Type + Lint)
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for changed file detection

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

  # Tests - run all tests with coverage
  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, quick-checks]
    # Run if frontend, api, or packages changed
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.api == 'true' || needs.detect-changes.outputs.packages == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run all tests with coverage (changed packages only)
        if: github.event_name == 'pull_request'
        run: |
          pnpm turbo run test --filter="...[origin/${{ github.base_ref }}]" -- --coverage
        env:
          NODE_ENV: test

      - name: Run all tests with coverage
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
        run: pnpm turbo run test -- --coverage
        env:
          NODE_ENV: test

  # Coverage report - combine all coverage
  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage
        continue-on-error: true

      - name: Install lcov (for genhtml)
        run: sudo apt-get update && sudo apt-get install -y lcov
      
      - name: Generate HTML report
        run: pnpm coverage:html
        continue-on-error: true

      - name: Upload merged coverage
        uses: actions/upload-artifact@v4
        with:
          name: merged-coverage
          path: coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let coverageMessage = 'üìä **Coverage Report Generated**\n\n';
            
            // Check if coverage was generated
            const coverageDir = path.join(process.cwd(), 'coverage');
            if (fs.existsSync(coverageDir)) {
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              coverageMessage += '‚úÖ Coverage report has been generated for this PR.\n';
              coverageMessage += `üìà [View Coverage Report](${runUrl})\n\n`;
              coverageMessage += 'üí° **Note**: This includes coverage for all tests run in CI.';
            } else {
              coverageMessage += '‚ö†Ô∏è **Coverage Report**: No coverage data was generated.\n\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: coverageMessage
            });
  full-test-suite:
    name: Full Test Suite (All Tests)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || contains(github.event.head_commit.message, '[full-tests]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run all tests with coverage
        run: pnpm test:coverage

      - name: Upload full coverage
        uses: actions/upload-artifact@v4
        with:
          name: full-coverage-report
          path: coverage/
          retention-days: 90
